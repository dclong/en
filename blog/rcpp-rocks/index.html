<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Rcpp Rocks</title>
  <meta name="author" content="Ben Chuanlong Du">

  <link href="http://www.legendu.net/en/atom.xml" type="application/atom+xml" rel="alternate"
        title="Ben Chuanlong Du's Blog Atom Feed" />


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://www.legendu.net/en/favicon.png" rel="icon">
  <link href="http://www.legendu.net/en/theme/css/main_2.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://www.legendu.net/en/theme/js/modernizr-2.0.js"></script>
  <script src="http://www.legendu.net/en/theme/js/ender.js"></script>
  <script src="http://www.legendu.net/en/theme/js/octopress.js" type="text/javascript"></script>

  <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://www.legendu.net/en/">Ben Chuanlong Du's Blog</a></h1>
    <h2>And let it direct your passion with reason.</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://www.legendu.net/en/atom.xml" rel="subscribe-rss">RSS</a></li>
</ul>

<form name="search" action="https://www.bing.com/search" method="get" onSubmit="return build_query()">
  <fieldset role="search">
      <!--
    <input type="hidden" name="q" value="site:http://www.legendu.net/en" />
        -->
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<script type = "text/javascript">
    function build_query() {
        var query = document.forms["search"]["q"].value;
        var prefix = "site:http://www.legendu.net/en "
        if (!query.startsWith(prefix)) {
            query = prefix + query;
            document.forms["search"]["q"].value = query;
        }
        return true;
    }
</script>

<ul class="main-navigation">
    <li><a href="http://www.legendu.net">Home</a></li>
    <li><a href="http://www.legendu.net/en">Blog</a></li>
    <li><a href="http://www.legendu.net/en/archives.html">Archives</a></li>
    <li><a href="http://www.legendu.net/pages/about">About</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Rcpp Rocks</h1>
      <p class="meta"><time datetime="2014-08-16T19:26:30-07:00" pubdate>Aug 16, 2014</time></p>
</header>

  <div class="entry-content"><p>Please see <a href="https://bitbucket.org/dclong/r-learn/src/">here</a> 
for some simple examples for learning Rcpp and related packages.</p>
<h2 id="tips">Tips</h2>
<ol>
<li>
<p>Though you can overload functions in a Rcpp module,
it causes problems when you export these overloaded functions.
This is because currently Rcpp cannot distinguish them when exporting them.
It is suggested that you do not overload functions that are to be exported.</p>
</li>
<li>
<p>The <code>Module</code> function in the "Rcpp" package 
might fail to load modules even if the C++ code is compiled successfully.
If this happens, 
you can try the option <code>mustStart = TRUE</code>.
It is suggested that you always use this option when you use the <code>Module</code> function.</p>
</li>
<li>
<p>Do not import the namespace <code>std</code> when using Rcpp. 
This causes name conflicts. 
It is also suggested that 
you always prefix functions with their namespace (even for Rcpp functions),
otherwise it is very error-prone.
For example, 
if you want to use the <code>std::abs</code> function 
but you forget the namespace (<code>std::</code>) prefix, 
the <code>Rcpp::abs</code> will be used instead. 
Your code will probably compile without any error message,
but the results won't be right. 
This kind of bug is very trick.
You'd better avoid it at the first place.</p>
</li>
<li>
<p>The following operations might cause segmentation fault and 
thus forces R to quit.</p>
<div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">Calling</span> <span class="k">C</span><span class="o">++</span> <span class="n">functions</span> <span class="k">with</span> <span class="n">wrong</span> <span class="nb">number</span> <span class="k">of</span> <span class="k">parameters</span><span class="p">.</span>

<span class="o">-</span> <span class="n">Unhandled</span> <span class="n">exceptions</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="k">g</span><span class="p">.,</span> <span class="k">out</span> <span class="k">of</span> <span class="n">bound</span><span class="p">).</span>

<span class="o">-</span> <span class="n">Use</span> <span class="n">Rcpp</span> <span class="n">module</span> <span class="k">from</span> <span class="n">previous</span> <span class="n">save</span> <span class="n">R</span> <span class="n">workspace</span> <span class="k">without</span> <span class="n">compiling</span> <span class="k">C</span><span class="o">++</span> <span class="n">code</span> <span class="n">again</span><span class="p">.</span>
</pre></div>


</li>
</ol>
<p>These operations are very dangerous, 
because you lose unsaved data in the R workspace when R is forced to quit. 
So you have to be very careful when you use C++ functions. 
It is recommended that you handle exceptions in C++ code. 
If you do not know how to handle exceptions in C++ code,
a safer way but a little tedious way is to always call C++ functions using the <code>try</code> function in R.</p>
<ol>
<li>
<p>In C++, 
methods for accessing elements of containers usually have both bound-checking 
and no-bound-checking versions. 
You should be aware that the no-bound-checking versions are more dangerous,
because your code might continue to run without any warning message after things to wrong.</p>
</li>
<li>
<p>Passing data between R and C++ is made easy. 
You can pass vectors, matrices and lists 
between R and C++ directly with the help of Rcpp. 
Rcpp takes care of the data converting automatically.
When you use the "RcppArmadillo" package, 
the converting between R objects and "Armadillo" matrices is also done automatically.</p>
</li>
<li>
<p>A list in R (and thus in Rcpp) is essentially a generic vector. 
You must know the structure of the list in order to work on it in Rcpp.
Each element of a <code>List</code> in Rcpp is of type <code>SEXP</code>. 
You have to first convert it to an Rcpp object 
and then work on it.</p>
</li>
<li>
<p>You can use reference of List in Rcpp, 
but a const reference of List is not allowed. 
Also though you can make a const reference of elements of a List,
I think it is misleading. 
Because a cast is usually need, 
I think a copy is often made. 
It is always good practice to transform a List object 
to a more type-strict data structure in C++ before you operate on it. </p>
</li>
<li>
<p>A vector in Rcpp can have names and you access an element by its name. 
However, 
different from R, 
error happens if you access element using a non-existing name. 
To avoid this, 
you can first use the <code>containsElementNamed</code> method 
of the Vector class to query whether an element 
with a specified name exists. 
Note that the <code>containsElementNamed</code> method accepts <code>const char *</code> as argument
not <code>std::string</code>. 
However, 
you can use the <code>c_str</code> method to convert std::string to <code>const char *</code>.</p>
</li>
<li>
<p>There is no data structure in R corresponding to <code>std::set</code> in C++. 
So when you <code>wrap</code> a set to an R object, 
it becomes an array/vector in R.
If you want to convert, 
say, 
a vector in R to a <code>std::set</code> in C++,
you have to first convert the vector in R 
to <code>std::vector</code> or <code>Rcpp::NumericVector</code> 
and then insert the vector into the set.</p>
</li>
<li>
<p>It is not convenient to get and operate on the names of a vector in Rcpp,
but you can pass the names of a vector/list to Rcpp as a vector from R. </p>
</li>
<li>
<p>You can use access R functions (in installed packages) easily in C++ code via Rcpp.
However, 
Rcpp is for extending R via C++, 
i.e., you have to come back to R. 
Trying to compile C++ code using Rcpp to and run binary code usually cause segmentation fault. </p>
</li>
<li>
<p>You can pass R functions (including user-defined functions) to Rcpp as Function objects, 
which is really convenient. 
The following is a silly illustration example. </p>
<div class="highlight"><pre><span></span><span class="nv">code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Function f(fun);</span>
<span class="nv">SEXP</span> <span class="nv">x</span> <span class="o">=</span> <span class="nv">f</span><span class="ss">()</span><span class="c1">;</span>
<span class="nv">int</span> <span class="nv">y</span> <span class="o">=</span> <span class="nv">as</span><span class="o">&amp;</span><span class="nv">lt</span><span class="c1">;int&amp;gt;(x);</span>
<span class="k">return</span> <span class="nv">wrap</span><span class="ss">(</span><span class="nv">y</span><span class="o">+</span><span class="mi">1</span><span class="ss">)</span><span class="c1">;&#39;</span>
<span class="nv">rwrap</span> <span class="o">=</span> <span class="nv">cxxfunction</span><span class="ss">(</span><span class="nv">signature</span><span class="ss">(</span><span class="nv">fun</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">function</span><span class="s2">&quot;</span><span class="ss">)</span>,<span class="nv">code</span>,<span class="nv">plugin</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Rcpp</span><span class="s2">&quot;</span><span class="ss">)</span>
</pre></div>


</li>
<li>
<p>C++11 support is still experimental in most C++ compilers. 
To enable the support of C++11 in g++, you can add the option <code>-std=c++0x</code> 
or <code>-std=c++11</code> (depending on the version of the compiler). 
In Rcpp, support of C++11 can be done throught the <code>settings</code> option 
of the <code>cxxfunction</code>. The following is an illustration example.  </p>
<div class="highlight"><pre><span></span><span class="nv">code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">std::vector&amp;lt;int&amp;gt; v{1,2,3};</span>
<span class="k">return</span> <span class="nv">wrap</span><span class="ss">(</span><span class="nv">v</span><span class="ss">)</span><span class="c1">;&#39;</span>
<span class="nv">settings</span><span class="o">=</span><span class="nv">getPlugin</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">Rcpp</span><span class="s2">&quot;</span><span class="ss">)</span>
<span class="nv">settings</span><span class="mh">$e</span><span class="nv">nv</span>$<span class="nv">PKG_CXXFLAGS</span><span class="o">=</span><span class="nv">paste</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">-std=c++0x </span><span class="s1">&#39;</span>,<span class="nv">settings</span><span class="mh">$e</span><span class="nv">nv</span>$<span class="nv">PKG_CXXFLAGS</span><span class="ss">)</span>
<span class="nv">fcpp11</span> <span class="o">=</span> <span class="nv">cxxfunction</span><span class="ss">(</span><span class="nv">body</span><span class="o">=</span><span class="nv">code</span>,<span class="nv">includes</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#include &amp;lt;vector&amp;gt;</span><span class="s2">&quot;</span>,<span class="nv">settings</span><span class="o">=</span><span class="nv">settings</span><span class="ss">)</span>
</pre></div>


</li>
<li>
<p>To link libraries, 
you have to add options to the <code>settings</code> argument of <code>cxxfunction</code>.
The following is an example of linking the GSL library. </p>
<div class="highlight"><pre><span></span><span class="nv">code</span> <span class="o">=</span> <span class="s1">&#39;</span>
<span class="nv">int</span> <span class="nv">n</span><span class="ss">(</span><span class="nv">as</span><span class="o">&amp;</span><span class="nv">lt</span><span class="c1">;int&amp;gt;(r_n));</span>
<span class="nv">double</span> <span class="nv">p</span><span class="ss">(</span><span class="nv">as</span><span class="o">&amp;</span><span class="nv">lt</span><span class="c1">;double&amp;gt;(r_p));</span>
<span class="nv">std</span>::<span class="nv">vector</span><span class="o">&amp;</span><span class="nv">lt</span><span class="c1">;double&amp;gt; x(n);</span>
<span class="nv">ralpha_wrapper</span><span class="ss">(</span><span class="nv">x</span>.<span class="nv">begin</span><span class="ss">()</span>, <span class="nv">x</span>.<span class="k">end</span><span class="ss">()</span>, <span class="nv">p</span><span class="ss">)</span><span class="c1">;</span>
<span class="k">return</span> <span class="nv">wrap</span><span class="ss">(</span><span class="nv">x</span><span class="ss">)</span><span class="c1">;</span>
<span class="s1">&#39;</span>
<span class="nv">includes</span> <span class="o">=</span> <span class="nv">readText</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">beta.cpp</span><span class="s1">&#39;</span><span class="ss">)</span>
<span class="nv">settings</span><span class="o">=</span><span class="nv">getPlugin</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">Rcpp</span><span class="s2">&quot;</span><span class="ss">)</span>
<span class="nv">settings</span><span class="mh">$e</span><span class="nv">nv</span>$<span class="nv">PKG_LIBS</span> <span class="o">=</span> <span class="nv">paste</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">-lgsl -lgslcblas </span><span class="s1">&#39;</span>, <span class="nv">settings</span><span class="mh">$e</span><span class="nv">nv</span>$<span class="nv">PKG_LIBS</span><span class="ss">)</span>
<span class="nv">settings</span><span class="mh">$e</span><span class="nv">nv</span>$<span class="nv">PKG_CXXFLAGS</span><span class="o">=</span><span class="nv">paste</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">-std=c++0x </span><span class="s1">&#39;</span>,<span class="nv">settings</span><span class="mh">$e</span><span class="nv">nv</span>$<span class="nv">PKG_CXXFLAGS</span><span class="ss">)</span>
<span class="nv">ralpha</span> <span class="o">=</span> <span class="nv">cxxfunction</span><span class="ss">(</span><span class="nv">signature</span><span class="ss">(</span><span class="nv">r_n</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">integer</span><span class="s2">&quot;</span>, <span class="nv">r_p</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">double</span><span class="s2">&quot;</span><span class="ss">)</span>, 
                <span class="nv">body</span><span class="o">=</span><span class="nv">code</span>, <span class="nv">includes</span><span class="o">=</span><span class="nv">includes</span>, <span class="nv">settings</span><span class="o">=</span><span class="nv">settings</span><span class="ss">)</span>
</pre></div>


</li>
</ol>
<h2 id="traps">Traps</h2>
<ol>
<li>
<p>Missing namespace prefix when calling functions that present in different namespaces.
For example,
if you want to use <code>std::abs</code> but forget the namespace prefix (<code>std::</code>),
the function <code>Rcpp::abs</code> will be used.
This is a very tricky bug.</p>
</li>
<li>
<p>Forget to synchronize the state of random number generators 
used in Rcpp with the one used in R. 
In this situation, 
random number generating functions in Rcpp always generate the same number. 
If you use random number generating functions in Rcpp but always get the same result, 
it's probably that you forget to synchronize the state of random number generators.
A simple way to synchronize the state of random number generators in Rcpp is to 
define a object of <code>RNGScope</code> before you call random number generating functions.
For example,
you can put the statement <code>RNGScope scope;</code> in the function/block that you have to call 
random number generating functions.</p>
</li>
</ol></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Ben Chuanlong Du</span>
  </span>
<time datetime="2014-08-16T19:26:30-07:00" pubdate>Aug 16, 2014</time>  <span class="categories">
    <a class="category" href="http://www.legendu.net/en/tag/c.html">C++</a>
    <a class="category" href="http://www.legendu.net/en/tag/list.html">list</a>
    <a class="category" href="http://www.legendu.net/en/tag/programming.html">programming</a>
    <a class="category" href="http://www.legendu.net/en/tag/hpc.html">HPC</a>
    <a class="category" href="http://www.legendu.net/en/tag/rcpp.html">Rcpp</a>
    <a class="category" href="http://www.legendu.net/en/tag/r.html">R</a>
    <a class="category" href="http://www.legendu.net/en/tag/rcpparmadillo.html">RcppArmadillo</a>
    <a class="category" href="http://www.legendu.net/en/tag/armadillo.html">Armadillo</a>
    <a class="category" href="http://www.legendu.net/en/tag/rock.html">rock</a>
  </span>
</p>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://www.legendu.net/en/blog/runtime-paths-in-python/">Runtime Paths in Python</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/en/blog/configuration-scripts-for-the-blog-project-on-notebooks.ai/">Configuration Scripts for the Blog Project on Notebooks.Ai</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/en/blog/string-in-python/">String in Python</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/en/blog/my-docker-images/">My Docker Images</a>
      </li>
      <li class="post">
          <a href="http://www.legendu.net/en/blog/docker-image-and-container-management/">Manage Docker Images and Containers</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://www.legendu.net/en/category/apple.html">Apple</a></li>
        <li><a href="http://www.legendu.net/en/category/fun-problems.html">Fun Problems</a></li>
        <li><a href="http://www.legendu.net/en/category/internet.html">internet</a></li>
        <li><a href="http://www.legendu.net/en/category/linux.html">Linux</a></li>
        <li><a href="http://www.legendu.net/en/category/network.html">Network</a></li>
        <li><a href="http://www.legendu.net/en/category/os.html">OS</a></li>
        <li><a href="http://www.legendu.net/en/category/programming.html">Programming</a></li>
        <li><a href="http://www.legendu.net/en/category/research.html">Research</a></li>
        <li><a href="http://www.legendu.net/en/category/software.html">Software</a></li>
        <li><a href="http://www.legendu.net/en/category/statistics.html">Statistics</a></li>
        <li><a href="http://www.legendu.net/en/category/work.html">Work</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
  <p class="tagcloud">
  </p>
  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/dclong">@dclong</a> on GitHub
    <script type="text/javascript">
      $.domReady(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'http://www.legendu.net/en/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'dclong',
              count: 3,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="http://www.legendu.net/en/theme/js/github.js" type="text/javascript"> </script>
  </section>

    <section>
        <h1>Social</h2>
        <ul>
            <li><a href="https://www.linkedin.com/in/ben-chuanlong-du-1239b221/" target="_blank">LinkedIn</a></li>
            <li><a href="https://twitter.com/longendu" target="_blank">Twitter</a></li>
            <li><a href="https://www.facebook.com/chuanlong.du" target="_blank">Facebook</a></li>
        <!--
            <li><a href="http://www.legendu.net/en/" type="application/rss+xml" rel="alternate">RSS</a></li>
            -->
        </ul>
    </section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Ben Chuanlong Du -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30259661-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
	<script type="text/javascript">
	  var disqus_shortname = 'dclong';
          var disqus_identifier = '/blog/rcpp-rocks/';
          var disqus_url = 'http://www.legendu.net/en/blog/rcpp-rocks/';
          var disqus_title = 'Rcpp Rocks';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
</body>
</html>